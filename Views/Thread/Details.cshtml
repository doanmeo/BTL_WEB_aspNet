@model BlogWebsite.Models.ViewModels.ThreadDetailsViewModel
@using BlogWebsite.Models
@using Microsoft.AspNetCore.Identity
@using System.Text.RegularExpressions
@using System.Text
@inject UserManager<AppUser> UserManager

@functions {
    public static string RenderPostBody(string? content)
    {
        if (string.IsNullOrWhiteSpace(content)) return string.Empty;

        var htmlIndicator = Regex.IsMatch(content, @"<\s*(p|div|img|blockquote|ul|ol|span|br|h\d|table)", RegexOptions.IgnoreCase);
        if (htmlIndicator)
        {
            return content!;
        }

        var normalized = content!.Replace("\r\n", "\n");
        normalized = normalized.Replace("\n", "<br>");
        normalized = Regex.Replace(normalized,
            @"\[QUOTE=""(.*?)""\]",
            "<blockquote class='quote-block'><strong>$1</strong><br>");
        normalized = normalized.Replace("[/QUOTE]", "</blockquote>");
        return normalized;
    }
}

@{
    ViewData["Title"] = Model.Thread.Title;
    var currentUser = await UserManager.GetUserAsync(User);
}

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2 rounded">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Forum" asp-action="Details" asp-route-id="@Model.Thread.ForumId">@Model.Thread.Forum.Name</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Thread.Title</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-primary">@Model.Thread.Title</h2>
        @if (User.Identity.IsAuthenticated)
        {
            <a href="#reply-area" class="btn btn-primary btn-sm shadow-sm">
                <i class="fa-solid fa-reply"></i> Post Reply
            </a>
        }
    </div>

    <p class="text-muted small"><i class="fa-solid fa-eye"></i> Views: @Model.Thread.ViewCount</p>

    @if (Model.Posts.Items.Any())
    {
        @foreach (var post in Model.Posts.Items)
        {
            <div class="card mb-3 post-card shadow-sm" id="post-@post.PostId">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-2 text-center bg-light p-3 border-end">
                            <img src="@Url.Content(post.AppUser.UserProfile?.AvatarUrl ?? "~/images/default-avatar.png")"
                                 alt="Avatar" class="img-thumbnail rounded-circle mb-2 shadow-sm"
                                 style="width: 80px; height: 80px; object-fit: cover;" />

                            <h6 class="mb-1 fw-bold text-break">
                                <a asp-controller="UserProfiles" asp-action="Details" asp-route-id="@post.AppUserId" class="text-decoration-none text-dark">
                                    @post.AppUser.UserName
                                </a>
                            </h6>

                            <div class="small text-muted mt-2">
                                <div>Joined: @(post.AppUser.UserProfile?.JoinedAt.ToString("MMM yyyy") ?? "N/A")</div>
                                <div>Reputation: @(post.AppUser.UserProfile?.Reputation ?? 0)</div>
                            </div>
                        </div>

                        <div class="col-md-10 p-3 d-flex flex-column">
                            <div class="d-flex justify-content-between border-bottom pb-2 mb-3 text-muted small">
                                <span><i class="fa-regular fa-clock"></i> @post.CreatedAt.ToString("dd/MM/yyyy HH:mm")</span>
                                <a href="#post-@post.PostId" class="text-muted text-decoration-none">#@post.PostId</a>
                            </div>

                            <div class="post-content flex-grow-1 mb-3 text-break">
                                @{
                                    var renderedContent = RenderPostBody(post.Content);
                                }
                                @Html.Raw(renderedContent)
                            </div>

                            <div class="d-flex justify-content-end align-items-center pt-2 mt-auto border-top">

                                @if (User.Identity.IsAuthenticated && post.AppUserId != currentUser?.Id)
                                {
                                    <a href="javascript:void(0);" class="text-secondary small me-3 text-decoration-none report-button" data-post-id="@post.PostId">
                                        <i class="fa-regular fa-flag"></i> Report
                                    </a>
                                }

                                <button class="btn btn-link text-decoration-none p-0 me-3 like-button" data-post-id="@post.PostId" style="color: #2f6f9f; font-size: 14px;">
                                    <i class="fa-regular fa-thumbs-up"></i> Like <span class="like-count fw-bold">0</span>
                                </button>

                                @{
                                    var encodedContent = Convert.ToBase64String(Encoding.UTF8.GetBytes(post.Content ?? string.Empty));
                                }
                                <a href="javascript:void(0);"
                                   class="btn btn-sm btn-outline-secondary btn-reply-quote fw-bold border-0"
                                   style="font-size: 13px;"
                                   data-username="@post.AppUser.UserName"
                                   data-content="@encodedContent">
                                    <i class="fa-solid fa-quote-left me-1"></i> Reply
                                </a>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info text-center py-4 shadow-sm">
            <i class="fa-regular fa-comments fa-2x mb-2"></i><br>
            Chưa có bài viết nào. Hãy là người đầu tiên bình luận!
        </div>
    }

    @if (Model.Posts.TotalPages > 1)
    {
        <nav aria-label="Post pagination" class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.Posts.HasPreviousPage ? "" : "disabled")">
                    <a class="page-link" asp-route-id="@Model.Thread.ThreadId" asp-route-page="@(Model.Posts.PageIndex - 1)">Previous</a>
                </li>
                @for (var i = 1; i <= Model.Posts.TotalPages; i++)
                {
                    <li class="page-item @(i == Model.Posts.PageIndex ? "active" : "")">
                        <a class="page-link" asp-route-id="@Model.Thread.ThreadId" asp-route-page="@i">@i</a>
                    </li>
                }
                <li class="page-item @(Model.Posts.HasNextPage ? "" : "disabled")">
                    <a class="page-link" asp-route-id="@Model.Thread.ThreadId" asp-route-page="@(Model.Posts.PageIndex + 1)">Next</a>
                </li>
            </ul>
        </nav>
    }

    <div id="reply-area" class="card mt-4 bg-light border-0 shadow-sm">
        @if (User.Identity.IsAuthenticated)
        {
            <div class="card-body">
                <h5 class="card-title mb-3 text-primary"><i class="fa-solid fa-pen"></i> Post a reply</h5>

                <form asp-controller="Post" asp-action="Create" method="post" id="replyForm">
                    <input type="hidden" name="ThreadId" value="@Model.Thread.ThreadId" />

                    <div id="quote-preview-box" class="alert alert-warning border-start border-4 border-warning d-none mb-3 position-relative shadow-sm">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" id="btn-remove-quote" aria-label="Close"></button>
                        <small class="fw-bold text-danger" id="quote-author"></small> said:
                        <div class="fst-italic mt-1 text-muted border-start ps-2" id="quote-content" style="max-height: 100px; overflow-y: auto;"></div>
                    </div>

                    <div class="form-group mb-3">
                        <input type="hidden" name="Content" id="replyContent" />
                        <div class="quill-wrapper">
                            <div id="replyEditor"></div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-controller="Forum" asp-action="Details" asp-route-id="@Model.Thread.ForumId" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-arrow-left"></i> Back to Forum
                        </a>
                        <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
                            Post reply <i class="fa-solid fa-paper-plane ms-1"></i>
                        </button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center m-3 shadow-sm">
                Bạn cần <a asp-area="Identity" asp-page="/Account/Login" class="fw-bold text-dark">Đăng nhập</a> hoặc <a asp-area="Identity" asp-page="/Account/Register" class="fw-bold text-dark">Đăng ký</a> để trả lời bài viết này.
            </div>
            <div class="mb-3 ms-3">
                <a asp-controller="Forum" asp-action="Details" asp-route-id="@Model.Thread.ForumId" class="btn btn-secondary">Back to Forum</a>
            </div>
        }
    </div>
</div>

@await Html.PartialAsync("_ReportModalPartial", new BlogWebsite.Models.ViewModels.ReportViewModel())

@section Styles{
    <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet" />
    <style>
        .quill-wrapper {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .quill-wrapper .ql-toolbar {
            background: #f8fafc;
        }

        .quill-wrapper .ql-container {
            min-height: 200px;
        }

        .quote-block {
            border-left: 4px solid #a855f7;
            padding-left: 1rem;
            margin: 1rem 0;
            background: #f8f5ff;
            color: #1f1f1f;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const replyEditorElement = document.querySelector('#replyEditor');
            if (!replyEditorElement) {
                return;
            }

            const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'align': [] }],
                ['blockquote', 'code-block', 'link', 'image'],
                ['clean']
            ];

            const replyQuill = new Quill('#replyEditor', {
                theme: 'snow',
                modules: {
                    toolbar: {
                        container: toolbarOptions,
                        handlers: {
                            'image': function () {
                                const range = this.quill.getSelection();
                                const url = prompt('Nhập URL hình ảnh:');
                                if (url) {
                                    this.quill.insertEmbed(range.index, 'image', url, Quill.sources.USER);
                                }
                            }
                        }
                    }
                }
            });

            let quoteHtml = '';

            $('.btn-reply-quote').on('click', function () {
                const username = $(this).data('username');
                const encoded = $(this).data('content');
                const decoded = encoded ? atob(encoded) : '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = decoded;
                const plain = tempDiv.textContent || tempDiv.innerText || decoded;
                quoteHtml = `<blockquote class="quote-block"><strong>${username} nói:</strong><br>${plain}</blockquote><p><br></p>`;

                $('#quote-author').text(username);
                $('#quote-content').text(plain);
                $('#quote-preview-box').removeClass('d-none');

                $('html, body').animate({
                    scrollTop: $('#reply-area').offset().top - 100
                }, 500);
            });

            $('#btn-remove-quote').on('click', function () {
                quoteHtml = '';
                $('#quote-preview-box').addClass('d-none');
                $('#quote-content').text('');
            });

            $('#replyForm').on('submit', function () {
                const html = replyQuill.root.innerHTML;
                $('#replyContent').val((quoteHtml || '') + html);
            });
        });
    </script>
}