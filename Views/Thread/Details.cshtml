@model BlogWebsite.Models.Thread
@using BlogWebsite.Models
@using BlogWebsite.Data
@using Microsoft.AspNetCore.Identity
@using System.Text.RegularExpressions
@inject UserManager<AppUser> UserManager
@inject ApplicationDbContext DbContext

@{
    ViewData["Title"] = Model.Title;
    var currentUser = await UserManager.GetUserAsync(User);
    var isWatching = currentUser != null && DbContext.WatchedThreads.Any(w => w.AppUserId == currentUser.Id && w.ThreadId == Model.ThreadId);
}

<div class="container my-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb bg-light p-2 rounded small">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Forum" asp-action="Details" asp-route-id="@Model.ForumId">@Model.Forum.Name</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Title</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold text-primary mb-0">@Model.Title</h2>
        @if (User.Identity.IsAuthenticated)
        {
            <div>
                <button id="watch-thread-btn" class="btn btn-sm @(isWatching ? "btn-dark" : "btn-outline-dark") me-2" data-thread-id="@Model.ThreadId">
                    <i class="fa-regular fa-star"></i> <span id="watch-thread-text">@(isWatching ? "Unwatch" : "Watch")</span>
                </button>
                <a href="#reply-area" class="btn btn-primary btn-sm shadow-sm">
                    <i class="fa-solid fa-reply"></i> Post Reply
                </a>
            </div>
        }
    </div>

    <p class="text-muted small mb-3"><i class="fa-solid fa-eye"></i> Views: @Model.ViewCount</p>

    @if (Model.Posts != null && Model.Posts.Any())
    {
        var orderedPosts = Model.Posts.OrderBy(p => p.CreatedAt).ToList();

        @foreach (var post in orderedPosts)
        {
            <div class="post-container" id="post-@post.PostId">

                <div class="post-user-cell">
                    <img src="@Url.Content(post.AppUser.UserProfile?.AvatarUrl ?? "~/images/default-avatar.png")"
                         class="post-avatar-img" alt="Avatar" />

                    <a asp-controller="UserProfiles" asp-action="Details" asp-route-id="@post.AppUserId" class="post-user-name">
                        @post.AppUser.UserName
                    </a>

                    <div class="post-user-title">
                        @{
                            var rep = post.AppUser.UserProfile?.Reputation ?? 0;
                            if (rep > 100)
                            {
                                <span class="badge bg-warning text-dark">Senior Member</span>
                                ;
                            }
                            else
                            {

                                <span>Member</span>
                                ;
                            }
                        }
                    </div>

                    <div class="post-user-stats">
                        <div>Joined: @(post.AppUser.UserProfile?.JoinedAt.ToString("MMM yy") ?? "N/A")</div>
                        <div>Likes: @rep</div>
                    </div>
                </div>

                <div class="post-content-cell">

                    <div class="post-header-bar">
                        <span><i class="fa-regular fa-clock"></i> @post.CreatedAt.ToString("dd/MM/yyyy 'at' HH:mm")</span>
                        <a href="#post-@post.PostId" class="text-muted text-decoration-none">#@post.PostId</a>
                    </div>

                    <div class="post-message text-break">
                        @{
                            var content = post.Content;
                            content = content.Replace("\n", "<br>");
                            content = Regex.Replace(content,
                            @"\[QUOTE=""(.*?)""\]",
                            @"<div class='alert alert-warning border-start border-4 border-warning p-2 mb-3 fst-italic bg-light text-dark shadow-sm small'><i class='fa-solid fa-quote-left text-danger me-1'></i> <strong>$1</strong> said:</div><div class='ps-3 border-start'>");
                            content = content.Replace("[/QUOTE]", "</div>");
                        }
                        @Html.Raw(content)
                    </div>

                    <div class="post-footer-bar">

                        @if (User.Identity.IsAuthenticated && (post.AppUserId == currentUser?.Id || User.IsInRole("Admin")))
                        {
                            <a asp-controller="Post" asp-action="Edit" asp-route-id="@post.PostId"
                               class="btn btn-sm btn-link text-secondary text-decoration-none me-2">
                                <i class="fa-solid fa-pen-to-square"></i> Edit
                            </a>
                        }

                        @if (User.Identity.IsAuthenticated && post.AppUserId != currentUser?.Id)
                        {
                            <a href="javascript:void(0);" class="btn btn-sm btn-link text-secondary text-decoration-none me-2 report-button" data-post-id="@post.PostId">
                                <i class="fa-regular fa-flag"></i> Report
                            </a>
                        }

                        <button class="btn btn-sm btn-light border me-2 like-button" data-post-id="@post.PostId">
                            <i class="fa-regular fa-thumbs-up text-primary"></i> Like <span class="like-count fw-bold">0</span>
                        </button>

                        <a href="javascript:void(0);"
                           class="btn btn-sm btn-outline-primary btn-reply-quote fw-bold"
                           data-username="@post.AppUser.UserName"
                           data-content="@post.Content">
                            <i class="fa-solid fa-quote-left me-1"></i> Reply
                        </a>
                    </div>
                </div>
            </div>
        }
    }
    else
    {
        <div class="alert alert-info text-center py-4 shadow-sm">
            <i class="fa-regular fa-comments fa-2x mb-2"></i><br>
            Chưa có bài viết nào. Hãy là người đầu tiên bình luận!
        </div>
    }

    <div id="reply-area" class="card mt-4 bg-light border-0 shadow-sm">
        @if (User.Identity.IsAuthenticated)
        {
            <div class="card-body">
                <h5 class="card-title mb-3 text-primary"><i class="fa-solid fa-pen"></i> Post a reply</h5>

                <form asp-controller="Post" asp-action="Create" method="post" id="replyForm">
                    <input type="hidden" name="ThreadId" value="@Model.ThreadId" />

                    <div id="quote-preview-box" class="alert alert-warning border-start border-4 border-warning d-none mb-3 position-relative shadow-sm">
                        <button type="button" class="btn-close position-absolute top-0 end-0 m-2" id="btn-remove-quote" aria-label="Close"></button>
                        <small class="fw-bold text-danger" id="quote-author"></small> said:
                        <div class="fst-italic mt-1 text-muted border-start ps-2" id="quote-content" style="max-height: 100px; overflow-y: auto;"></div>
                        <input type="hidden" id="hidden-quote-string" name="QuoteString" />
                    </div>

                    <div class="form-group mb-3">
                        <textarea id="replyEditor" name="Content" class="form-control" rows="6" placeholder="Viết bình luận của bạn..."></textarea>
                    </div>

                    <div class="d-flex justify-content-between">
                        <a asp-controller="Forum" asp-action="Details" asp-route-id="@Model.ForumId" class="btn btn-outline-secondary">
                            <i class="fa-solid fa-arrow-left"></i> Back to Forum
                        </a>
                        <button type="submit" class="btn btn-primary px-4 fw-bold shadow-sm">
                            Post reply <i class="fa-solid fa-paper-plane ms-1"></i>
                        </button>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="alert alert-warning text-center m-3 shadow-sm">
                Bạn cần <a asp-area="Identity" asp-page="/Account/Login" class="fw-bold text-dark">Đăng nhập</a> hoặc <a asp-area="Identity" asp-page="/Account/Register" class="fw-bold text-dark">Đăng ký</a>.
            </div>
        }
    </div>
</div>

<div id="dynamic-modal-container"></div>

@section Scripts {
    <script>
        $(document).ready(function () {

            // 1. Xử lý Reply Quote
            $('.btn-reply-quote').click(function () {
                var username = $(this).data('username');
                var rawContent = $(this).data('content');
                var cleanContent = rawContent.replace(/\[QUOTE[\s\S]*?\[\/QUOTE\]/g, "").trim();

                $('#quote-author').text(username);
                $('#quote-content').text(cleanContent);

                var bbCode = `[QUOTE="${username}"]\n${cleanContent}\n[/QUOTE]\n`;
                $('#hidden-quote-string').val(bbCode);
                $('#quote-preview-box').removeClass('d-none');

                $('html, body').animate({ scrollTop: $('#reply-area').offset().top - 100 }, 500);
                $('#replyEditor').focus();
            });

            // 2. Nút X Quote
            $('#btn-remove-quote').click(function () {
                $('#quote-preview-box').addClass('d-none');
                $('#hidden-quote-string').val('');
                $('#quote-content').text('');
            });

            // 3. Submit Form Reply
            $('#replyForm').submit(function () {
                var quote = $('#hidden-quote-string').val();
                var newReply = $('#replyEditor').val();
                if (quote && quote.trim() !== "") {
                    $('#replyEditor').val(quote + newReply);
                }
                return true;
            });

            // 4. Watch Thread
            $('#watch-thread-btn').click(function () {
                var button = $(this);
                var textSpan = $('#watch-thread-text');
                var threadId = button.data('thread-id');
                var url = '/Thread/ToggleWatch';

                $.post(url, { threadId: threadId })
                    .done(function (response) {
                        if (response.isWatched) {
                            button.removeClass('btn-outline-dark').addClass('btn-dark');
                            textSpan.text('Unwatch');
                        } else {
                            button.removeClass('btn-dark').addClass('btn-outline-dark');
                            textSpan.text('Watch');
                        }
                    })
                    .fail(function () { alert("Lỗi kết nối server."); });
            });

            // 5. Xử lý nút Report (Thêm mới)
            $('.report-button').click(function (e) {
                e.preventDefault();
                var postId = $(this).data('post-id');
                // Gọi về Server lấy Modal
                $.get('/Thread/ReportPost/' + postId, function (data) {
                    $('#dynamic-modal-container').html(data);
                    var myModal = new bootstrap.Modal(document.getElementById('reportModal'));
                    myModal.show();
                });
            });

           // ========================================
            // 5. XỬ LÝ NÚT REPORT (BÁO CÁO)
            // ========================================

            // Dùng $(document).on('click') để bắt sự kiện chắc chắn hơn
            $(document).on('click', '.report-button', function (e) {
                e.preventDefault();
                var postId = $(this).data('post-id');
                console.log("Đang báo cáo bài viết ID:", postId); // Kiểm tra F12 xem có chạy dòng này không

                // Gọi về Server lấy Modal
                $.get('/Thread/ReportPost/' + postId, function (data) {
                    // 1. Nhét HTML vào container
                    $('#dynamic-modal-container').html(data);

                    // 2. Tìm phần tử Modal vừa nhét vào
                    var modalElement = document.getElementById('reportModal');

                    if (modalElement) {
                        // 3. Khởi tạo và hiển thị bằng Bootstrap
                        var myModal = new bootstrap.Modal(modalElement);
                        myModal.show();
                    } else {
                        alert("Lỗi: Không tạo được giao diện Modal.");
                    }
                }).fail(function() {
                    alert("Lỗi kết nối Server (404 hoặc 500). Kiểm tra lại Controller.");
                });
            });

            // Xử lý Submit Report trong Modal (Giữ nguyên logic cũ)
            $(document).on('submit', '#reportForm', function (e) {
                e.preventDefault();
                var form = $(this);
                $.post(form.attr('action'), form.serialize(), function (response) {
                    if (response.success) {
                        // Tìm modal đang mở để đóng nó lại
                        var modalEl = document.getElementById('reportModal');
                        var modalInstance = bootstrap.Modal.getInstance(modalEl);
                        modalInstance.hide();

                        alert(response.message);
                    } else {
                        alert("Lỗi: " + response.message);
                    }
                }).fail(function() {
                    alert("Lỗi kết nối khi gửi báo cáo.");
                });
            });
        });
    </script>
}